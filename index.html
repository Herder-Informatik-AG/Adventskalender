<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>Adventskalender - DEMO</title>
</head>
<div class="root">
  <div class="width-large">
    <div class="row">
      <div class="col-12 ce_image first block no-margin" id="adventskalender">
        <div class="inner">
          <figure class="image-container">
            <div class="image-mask">
              <img src="assets/46_night.png" width="800" height="564" alt="" itemprop="image">
            </div>
          </figure>
        </div>
      </div>
    </div>
  </div>
  <div id="debug">
    <p>Mouse position: <span id="mousePos"></span></p>
    <p>Last click position: <span id="clickPos"></span></p>
    <p>Current radius: <span id="radius"></span></p>
  </div>
</div>

<script>
  var lastClick = [0, 0];
  adventskalender.addEventListener("mousemove", updateDebug);
  adventskalender.addEventListener("click", updateDebugClick);
  
  /**
   * Updates the debug information
   */
  function updateDebug() {
    // Display mousepos rounded to 2 decimal places:
    var radius = Math.sqrt((mousePos[0] - lastClick[0]) * (mousePos[0] - lastClick[0]) + (mousePos[1] - lastClick[1]) * (mousePos[1] - lastClick[1]));
    document.querySelector('#mousePos').innerHTML = mousePos.map(x => x.toFixed(2));
    document.querySelector('#clickPos').innerHTML = lastClick.map(x => x.toFixed(2));
    document.querySelector('#radius').innerHTML = radius.toFixed(2);
  }

  function updateDebugClick(e) {
    lastClick = mousePos;
    updateDebug();
  }
</script>

<!-- COPY EVERYTHING BELOW THIS INTO "ce_html5-Adventskalender" -->

<script>
  var adventskalender = document.querySelector('#adventskalender img');
  var radius = 0.05;

  // Coordinates of the doors. The coordinates are relative to the image size, i.e. in [0, 1]
  var doors = [
    [0.6, 0.51], // 1
    [0.41, 0.67], // 2
    [0.92, 0.62], // 3
    [0.18, 0.05], // 4
    [0.76, 0.7], // 5
    [0.16, 0.72], // 6
    [0.82, 0.06], // 7
    [0.33, 0.83], // 8
    [0.15, 0.87], // 9
    [0.07, 0.52], // 10
    [0.5, 0.36], // 11
    [0.72, 0.41], // 12
    [0.95, 0.74], // 13
    [0.15, 0.39], // 14
    [0.64, 0.25], // 15
    [0.68, 0.92], // 16
    [0.27, 0.17], // 17
    [0.56, 0.86], // 18
    [0.31, 0.34], // 19
    [0.27, 0.61], // 20
    [0.14, 0.18], // 21
    [0.81, 0.28], // 22
    [0.44, 0.14], // 23
    [0.56, 0.07] // 24
  ];

  var MousePos = [];

  adventskalender.addEventListener("mousemove", handleMouseMove);
  adventskalender.addEventListener("click", handleClick);

  /**
   * Computes the relative coordinates of the mouse inside the image. Both coordinates are in [0, 1]
   */
  function getMousePos(e){
    const x = e.offsetX / e.target.width;
    const y = e.offsetY / e.target.height;
    return [x, y];
  }

  /**
   * Checks whether a point is close enough to a door to be considered a click on that door.
   */
  function pointInCircle(x, y, cx, cy, r) {
    var squaredDist = (x - cx) * (x - cx) + (y - cy) * (y - cy);
    return r * r >= squaredDist;
  }

  /**
   * Checks whether the mouse is over a door. If so, returns the ID of the door. Otherwise, returns 0.
   */
  function findDoor(MousePos) {
    for(i = 0; doors.length > i; i++) {
      var door = doors[i];
      if(pointInCircle(MousePos[0], MousePos[1], door[0], door[1], radius * (1 + (i == 23)))) {
        return i + 1;
      }
    }
    return null;
  }

  /**
   * Opens the door with the given ID
   */
  function openDoor(doorID){
    if (!canBeOpened(doorID)) {
      window.alert("Tür " + doorID + " kann noch nicht geöffnet werden! Bitte warte bis zum " + doorID + ". Dezember.");
      return;
    }
    // Direct the user to the path of the door
    window.location.href = "/adventskalender-" + doorID;
  }

  /**
   * Checks whether the door can be opened based on day of the month.
   */
  function canBeOpened(doorID) {
    var today = new Date();
    var day = today.getDate();
    return day >= doorID;
  }

  /**
   * Handles the click event on the image. If the click is on a door, the door is opened.
   */
  function handleClick(e) {
    MousePos = getMousePos(e);
    var clickGoal = findDoor(MousePos);
    if(clickGoal > 0) {
      openDoor(clickGoal);
    }
  }

  /**
   * Changes the style of the cursor depending on whether the mouse is over a door or not
   */
  function handleMouseMove(e) {
    mousePos = getMousePos(e);
    if(findDoor(mousePos) > 0) {
      if (canBeOpened(findDoor(mousePos))) {
        adventskalender.style.cursor = "pointer";
      } else {
        adventskalender.style.cursor = "not-allowed";
      }
    } else {
      adventskalender.style.cursor = "default";
    }
  }
</script>
<style>
  #adventskalender img {
    border-radius: 10px;
    width: auto;
    max-height: max-content;
  }
</style>